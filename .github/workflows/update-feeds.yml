name: Update RSS and iCal Feeds

# Grant workflow permission to write back to repo
permissions:
  contents: write

on:
  schedule:
    # Run every hour at minute 5
    - cron: '5 * * * *'
  # Allow manual triggering
  workflow_dispatch:

# Prevent multiple concurrent runs of this workflow
concurrency:
  group: update-feeds-${{ github.ref }}
  cancel-in-progress: true
  
jobs:
  update-feeds:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
      
    - name: Install dependencies
      run: npm ci  # Clean install based on package-lock.json
      
    - name: Create data directory if it doesn't exist
      run: mkdir -p data
      
    - name: Generate RSS feed
      run: node scripts/generate_rss.js
      continue-on-error: true
      
    - name: Generate iCal feed
      run: node scripts/generate_ical.js
      continue-on-error: true
      
    - name: Commit and push if changes
      run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add data/opportunities.rss data/opportunities.ics community-events/data/events.rss community-events/data/events.ics
          # This command checks if there are any staged changes.
          # If there are, it commits and pushes. Otherwise, it does nothing.
          if ! git diff --staged --quiet; then
            git commit -m "chore: update RSS and iCal feeds [skip ci]"
            git push
          else
            echo "No changes to commit."
          fi
      env:
        # This token is automatically provided by GitHub Actions
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}